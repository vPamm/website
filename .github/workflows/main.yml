name: Update Latest YouTube Videos

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  update-videos:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Fetch newest video A
        id: fetchA
        env:
          CHANNEL_A: ${{ secrets.YT_CHANNEL_ID_A }}
        run: |
          FEED=$(curl -s "https://www.youtube.com/feeds/videos.xml?channel_id=$CHANNEL_A")
          echo "$FEED" | grep -m1 '<entry>'
          VID=$(echo "$FEED" | grep -oPm1 '(?<=<yt:videoId>)[^<]+')
          echo "id=$VID" >> $GITHUB_OUTPUT

      - name: Fetch newest video B
        id: fetchB
        env:
          CHANNEL_B: ${{ secrets.YT_CHANNEL_ID_B }}
        run: |
          FEED=$(curl -s "https://www.youtube.com/feeds/videos.xml?channel_id=$CHANNEL_B")
          echo "$FEED" | grep -m1 '<entry>'
          VID=$(echo "$FEED" | grep -oPm1 '(?<=<yt:videoId>)[^<]+')
          echo "id=$VID" >> $GITHUB_OUTPUT

      - name: Update and push config
        run: |
          CFG="_config.yml"  # ← adjust to `config.yml` if that’s what your theme uses
          
          # Replace placeholders
          sed -i 's|VIDEO_A_PLACEHOLDER|https://youtu.be/${{ steps.fetchA.outputs.id }}|g' $CFG
          sed -i 's|VIDEO_B_PLACEHOLDER|https://youtu.be/${{ steps.fetchB.outputs.id }}|g' $CFG

          # Commit & push in one shot
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add $CFG
          if ! git diff --cached --quiet; then
            git commit -m "chore: bump latest YouTube videos to ${{ steps.fetchA.outputs.id }} & ${{ steps.fetchB.outputs.id }}"
            git push
          else
            echo "No changes to commit."
          fi
