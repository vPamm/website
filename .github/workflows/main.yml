name: Update Latest YouTube Video Links

on:
  schedule:
    - cron:  '0 * * * *'    # hourly
  workflow_dispatch:

jobs:
  update-videos:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch newest video for Channel A
        id: fetchA
        run: |
          FEED=$(curl -s "https://www.youtube.com/feeds/videos.xml?channel_id=${{ secrets.YT_CHANNEL_ID_A }}")
          VID=$(echo "$FEED" | grep -oPm1 '(?<=<yt:videoId>)[^<]+')
          echo "id=$VID" >> $GITHUB_OUTPUT

      - name: Fetch newest video for Channel B
        id: fetchB
        run: |
          FEED=$(curl -s "https://www.youtube.com/feeds/videos.xml?channel_id=${{ secrets.YT_CHANNEL_ID_B }}")
          VID=$(echo "$FEED" | grep -oPm1 '(?<=<yt:videoId>)[^<]+')
          echo "id=$VID" >> $GITHUB_OUTPUT

      - name: Update Linkyee config
        run: |
          CFG="_config.yml"
          # Replace the placeholders with the real URLs
          sed -i "/Watch my Channel A latest video/{n;s|url:.*|url: \"https://youtu.be/${{ steps.fetchA.outputs.id }}\"|}" $CFG
          sed -i "/Watch my Channel B latest video/{n;s|url:.*|url: \"https://youtu.be/${{ steps.fetchB.outputs.id }}\"|}" $CFG

      - name: Commit & push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add _config.yml
          if ! git diff --cached --quiet; then
            git commit -m "chore: bump YouTube video links to ${ { steps.fetchA.outputs.id } } and ${ { steps.fetchB.outputs.id } }"
            git push
          fi
