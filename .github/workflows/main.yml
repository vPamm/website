name: Update Latest YouTube Videos

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  update-videos:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Fetch newest video A
        id: fetchA
        env:
          CHANNEL_A: ${{ secrets.YT_CHANNEL_ID_A }}
        run: |
          FEED=$(curl -s "https://www.youtube.com/feeds/videos.xml?channel_id=$CHANNEL_A")
          echo "$FEED" | grep -m1 '<entry>'
          VID=$(echo "$FEED" | grep -oPm1 '(?<=<yt:videoId>)[^<]+')
          echo "id=$VID" >> $GITHUB_OUTPUT

      - name: Fetch newest video B
        id: fetchB
        env:
          CHANNEL_B: ${{ secrets.YT_CHANNEL_ID_B }}
        run: |
          FEED=$(curl -s "https://www.youtube.com/feeds/videos.xml?channel_id=$CHANNEL_B")
          echo "$FEED" | grep -m1 '<entry>'
          VID=$(echo "$FEED" | grep -oPm1 '(?<=<yt:videoId>)[^<]+')
          echo "id=$VID" >> $GITHUB_OUTPUT

      - name: Update and push config
        run: |
          CFG="config.yml"    # or _config.yml, whatever your theme uses

          # Channel A: look for the link titled “Watch my Channel A latest video”,
          # then on the next line replace whatever url: … is there.
          sed -i '/text: "Watch my Channel A latest video"/{
              n
              s|url: .*|url: "https://youtu.be/${{ steps.fetchA.outputs.id }}"|
            }' $CFG

          # Channel B:
          sed -i '/text: "Watch my Channel B latest video"/{
              n
              s|url: .*|url: "https://youtu.be/${{ steps.fetchB.outputs.id }}"|
            }' $CFG

          # commit & push if anything changed
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add $CFG
          if ! git diff --cached --quiet; then
            git commit -m "chore: bump YouTube videos to ${{ steps.fetchA.outputs.id }} & ${{ steps.fetchB.outputs.id }}"
            git push
          else
            echo "No changes—URLs are already up to date."
          fi
