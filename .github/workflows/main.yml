name: Update Latest YouTube Video Links

on:
  schedule:
    - cron: '0 * * * *'       # run hourly (adjust as needed)
  workflow_dispatch:

jobs:
  update-videos:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Fetch newest video A via Data API
        id: fetchA
        env:
          API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          CHANNEL_A: ${{ secrets.YT_CHANNEL_ID_A }}
        run: |
          echo "🔍 Querying Data API for Channel A"
          VID=$(
            curl -s "https://www.googleapis.com/youtube/v3/search?key=$API_KEY&channelId=$CHANNEL_A&order=date&part=id&maxResults=1&type=video" \
            | jq -r '.items[0].id.videoId'
          )
          echo "Latest video ID (A): $VID"
          echo "id=$VID" >> $GITHUB_OUTPUT

      - name: Fetch newest video B via Data API
        id: fetchB
        env:
          API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          CHANNEL_B: ${{ secrets.YT_CHANNEL_ID_B }}
        run: |
          echo "🔍 Querying Data API for Channel B"
          VID=$(
            curl -s "https://www.googleapis.com/youtube/v3/search?key=$API_KEY&channelId=$CHANNEL_B&order=date&part=id&maxResults=1&type=video" \
            | jq -r '.items[0].id.videoId'
          )
          echo "Latest video ID (B): $VID"
          echo "id=$VID" >> $GITHUB_OUTPUT

      - name: Update and push config
        run: |
          CFG="config.yml"    # or _config.yml, whichever your site uses

          # Replace the URL lines directly under each link text:
          sed -i '/text: "Watch my Channel A latest video"/{
                    n
                    s|url: .*|url: "https://youtu.be/${{ steps.fetchA.outputs.id }}"|
                  }' $CFG
          sed -i '/text: "Watch my Channel B latest video"/{
                    n
                    s|url: .*|url: "https://youtu.be/${{ steps.fetchB.outputs.id }}"|
                  }' $CFG

          # Commit & push if changed
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add $CFG
          if ! git diff --cached --quiet; then
            git commit -m "chore: bump YouTube videos to ${{ steps.fetchA.outputs.id }} & ${{ steps.fetchB.outputs.id }}"
            git push
          else
            echo "No changes—URLs are already up to date."
          fi
